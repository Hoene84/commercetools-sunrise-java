<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CountryOperations.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=2;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jacoco Coverage Report</a> &gt; <a href="index.source.html" class="el_package">common.countries</a> &gt; <span class="el_source">CountryOperations.java</span></div><h1>CountryOperations.java</h1><pre class="source lang-java linenums">package common.countries;

import com.neovisionaries.i18n.CountryCode;
import play.Configuration;
import play.Logger;
import play.mvc.Http;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Optional;

public class CountryOperations {
    public static final String COUNTRY_SESSION_KEY = &quot;SHOP_COUNTRY&quot;;
    public static final String COUNTRY_CONFIG_LIST = &quot;sphere.countries&quot;;
<span class="fc" id="L16">    public static final Logger.ALogger LOGGER = Logger.of(CountryOperations.class);</span>
    private final Configuration configuration;

<span class="fc" id="L19">    private CountryOperations(Configuration configuration) {</span>
<span class="fc" id="L20">        this.configuration = configuration;</span>
<span class="fc" id="L21">    }</span>

    public static CountryOperations of(Configuration configuration) {
<span class="fc" id="L24">        return new CountryOperations(configuration);</span>
    }

    /**
     * Gets the country associated with the user.
     * @return the country stored in session, or the default country of the shop if none stored.
     */
    public CountryCode country() {
<span class="fc" id="L32">        return countryInSession().orElse(defaultCountry());</span>
    }

    /**
     * Gets the list of available countries for this shop, as defined in the configuration file.
     * @return the list of available countries.
     */
    public List&lt;CountryCode&gt; availableCountries() {
<span class="fc" id="L40">        List&lt;CountryCode&gt; countries = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L41" title="All 2 branches covered.">        for (String configCountry : configCountryList()) {</span>
<span class="fc" id="L42">            parseCode(configCountry).ifPresent(countries::add);</span>
<span class="fc" id="L43">        }</span>
<span class="fc" id="L44">        return countries;</span>
    }

    /**
     * Gets the default country for this shop, as defined in the configuration file.
     * @return the first valid country defined in the configuration file.
     * @throws DefaultCountryNotFound when a default valid country could not be found.
     */
    public CountryCode defaultCountry() {
<span class="fc" id="L53">        List&lt;CountryCode&gt; availableCountries = availableCountries();</span>
<span class="fc bfc" id="L54" title="All 2 branches covered.">        if (!availableCountries.isEmpty()) {</span>
<span class="fc" id="L55">            return availableCountries.get(0);</span>
        } else {
<span class="fc" id="L57">            throw new DefaultCountryNotFound();</span>
        }
    }

    /**
     * Sets the country associated with the user, if a valid country code is provided.
     * @param countryCodeAsString the string representing a country code.
     * @throws InvalidCountryCode when the country code does not correspond to a valid country.
     */
    public void changeCountry(String countryCodeAsString) {
<span class="fc" id="L67">        CountryCode countryCode = parseCode(countryCodeAsString)</span>
<span class="fc" id="L68">                .orElseThrow(() -&gt; new InvalidCountryCode(countryCodeAsString));</span>
<span class="fc" id="L69">        changeCountry(countryCode);</span>
<span class="fc" id="L70">    }</span>

    /**
     * Parses a country code as string.
     * @param countryCodeAsString the string representing a country code.
     * @return the country code represented in the string, or absent if it does not correspond to a valid country.
     */
    public static Optional&lt;CountryCode&gt; parseCode(String countryCodeAsString) {
        try {
<span class="fc" id="L79">            return Optional.of(CountryCode.valueOf(countryCodeAsString));</span>
<span class="fc" id="L80">        } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L81">            LOGGER.warn(&quot;Invalid country &quot; + countryCodeAsString);</span>
<span class="fc" id="L82">            return Optional.empty();</span>
        }
    }

    /**
     * Sets the country associated with the user.
     * @param countryCode the desired country for the user.
     */
    private void changeCountry(CountryCode countryCode) {
<span class="fc bfc" id="L91" title="All 2 branches covered.">        if (availableCountries().contains(countryCode)) {</span>
<span class="fc" id="L92">            Http.Context.current().session().put(COUNTRY_SESSION_KEY, countryCode.getAlpha2());</span>
        }
<span class="fc" id="L94">    }</span>

    /**
     * Gets the country stored in session.
     * @return the country stored in the session, or absent if none stored.
     */
    private Optional&lt;CountryCode&gt; countryInSession() {
<span class="fc" id="L101">        Http.Session session = Http.Context.current().session();</span>
<span class="fc" id="L102">        Optional&lt;String&gt; code = Optional.ofNullable(session.get(COUNTRY_SESSION_KEY));</span>
<span class="fc" id="L103">        return code.flatMap(CountryOperations::parseCode);</span>
    }

    /**
     * Gets the list of countries for this project.
     * @return the list of countries as defined in the configuration file, or empty list if none defined.
     */
    private List&lt;String&gt; configCountryList() {
<span class="fc" id="L111">        return configuration.getStringList(COUNTRY_CONFIG_LIST, Collections.emptyList());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>